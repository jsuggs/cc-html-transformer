<!DOCTYPE>
<html>
<head>
    <title>CC (X)HTML Transformer</title>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container">
    <h1>CC (X)HTML Transformer</h1>

    <form role="form">
        <div class="form-group">
            <label for="linkappend">Append to all Links (do NOT include the leading ? or &amp;)</label>
            <input id="linkappend" class="form-control" placeholder="utm_campaign=&utm_source=cc&utm_medium=campaign&loginUserIdKey=$Subscriber.Custom.Loginkey">
        </div>
        <div class="form-group">
            <p class="help-block">
                Paste the (x)html code in the text area below, then click the magic button.<br />
                <span class="text-danger">Note: you need to paste the full (x)html source.</span>
            </p>
            <textarea id="from" class="form-control" placeholder="Paste (x)html here." rows="10"></textarea>
        </div>
        <div class="form-group">
            <button id="doit" class="btn btn-success btn-lg">Make Magic Happen</button>
        </div>
        <div class="form-group">
            <textarea id="to" class="form-control" rows="10" placeholder="CC (x)html will be placed here."></textarea>
        </div>
    </form>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        $("#doit").click(function(e) {
            e.preventDefault();

            // Save the original html
            var html = $("#from").val();
            var linkAppend = $("#linkappend").val();

            // Get just the text between the body tags (because jQuery gets all weird with html, head and body tags)
            body = html.match(/<body[^>]*>[\s\S]*(.*)<\/body>/m)[0].trim();
            body = body.substring(body.indexOf('>')+1);
            body = body.substring(0, body.length - 7).trim();

            // Get a jQuery object of the body html
            var $from = $(body);

            // wrap all of the a tags with the CC specific tags
            $from.find('a').replaceWith(function() {
                var $a = $($(this)[0].outerHTML);
                href = $a.attr('href');
                href += href.indexOf('&') == -1 ? '&' : '?';
                href += linkAppend;
                $a.attr('href', href);
                var $sup = $('<SimpleURLProperty>')
                    .attr('name', 'mylink')
                    .attr('track', true)
                    .attr('label', 'bar')
                    .attr('href', $a.attr('href'))
                    .prepend($a[0].outerHTML)
                ;

              return $('<SimpleURLProperty>').append($sup.clone()).html();
            });

            // Replace back inside the body
            final = html.replace(/<body([^>]*)>[\s\S]*(.*)<\/body>/m, '<body$1>' + $from[0].outerHTML + '</body>')

            // Write back the final result
            $("#to").val(final);
        });
    });
</script>
</body>
</html>
